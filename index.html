<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Gerador ESIP Profissional</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{background:#2b0000;color:white;font-family:Arial,sans-serif;text-align:center;margin:0;padding:20px;}
.container{max-width:420px;margin:auto;background:#3a0000;padding:20px;border-radius:15px;box-shadow:0 0 12px #ff000033;}
label{display:block;text-align:left;margin-top:15px;}
input,select{width:100%;padding:10px;border-radius:6px;border:none;margin-top:5px;background:#550000;color:white;}
button{width:100%;padding:12px;background:#ff0000;color:white;border:none;border-radius:10px;font-size:18px;margin-top:18px;cursor:pointer;}
#qrcode{margin-top:20px;}
#previewLogo{max-width:100px;margin-top:8px;border-radius:6px;display:none;}
#loginBox,#adminArea{display:none;background:#1a0000;padding:20px;border-radius:12px;max-width:900px;margin:40px auto;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #660000;padding:6px;text-align:left;font-size:14px;}
th{background:#330000;}
.small{font-size:13px;opacity:.9;}
.header-row{display:flex;justify-content:space-between;align-items:center;max-width:900px;margin:0 auto 18px;}
.notice{margin-top:8px;color:#aaffcc;}
.admin-tools{display:flex;gap:10px;margin:15px 0;flex-wrap:wrap;}
.admin-tools input{flex:1;}
.admin-tools button{width:auto;padding:10px 14px;font-size:14px;}
</style>
</head>

<body>

<div class="header-row">
  <h2>ğŸ“¡ ESIP - Gerador de Ingressos</h2>
  <button onclick="mostrarLogin()">ğŸ” Ãrea do Administrador</button>
</div>

<div class="container">
    <label>Nome:</label>
    <input id="nome">

    <label>Evento:</label>
    <input id="evento" oninput="this.value=this.value.toUpperCase()">

    <label>Logo do Evento:</label>
    <input type="file" id="logoEvento" accept="image/*">
    <img id="previewLogo">

    <label>Portaria:</label>
    <select id="portaria">
        <option value="A">Portaria A</option>
        <option value="B">Portaria B</option>
        <option value="C">Portaria C</option>
    </select>

    <label>CPF:</label>
    <input id="cpf" maxlength="11" oninput="this.value=this.value.replace(/\D/g,'')">

    <button onclick="gerarQR()">Gerar QR</button>
    <div id="qrcode"></div>
    <button onclick="baixarPDF()">ğŸ“„ Baixar PDF</button>
    <p id="status" class="notice"></p>
</div>

<div id="loginBox">
    <h3>ğŸ” Login do Administrador</h3>
    <input id="senhaAdmin" type="password">
    <button onclick="validarAdmin()">Entrar</button>
    <button onclick="fecharLogin()">Cancelar</button>
</div>

<div id="adminArea">
    <h2>ğŸ“‹ Registros</h2>
    <div class="small">Total: <span id="contadorRegistros">0</span></div>

    <div class="admin-tools">
        <input id="buscarCPF" placeholder="Buscar por CPF">
        <button onclick="buscarPorCPF()">ğŸ” Buscar</button>
        <button onclick="carregarRegistros()">ğŸ”„ Limpar</button>
    </div>

    <button onclick="exportCSV()">ğŸ“¤ Exportar CSV</button>
    <button onclick="exportarPDFPortaria()">ğŸ“„ Exportar PDF por Portaria</button>
    <button onclick="limparRegistros()">ğŸ—‘ï¸ Limpar Tudo</button>
    <button onclick="fecharAdmin()">ğŸ”™ Voltar</button>

    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Evento</th>
                <th>CPF</th>
                <th>Portaria</th>
                <th>ID</th>
                <th>Data/Hora</th>
                <th>AÃ§Ãµes</th>
            </tr>
        </thead>
        <tbody id="registrosTabela"></tbody>
    </table>
</div>

<script>
let ultimoID="",LOGO_EVENTO_DATAURL="";

function agora(){
    const d=new Date();
    return d.toLocaleDateString("pt-BR")+" "+d.toLocaleTimeString("pt-BR");
}

function _getRegistros(){return JSON.parse(localStorage.getItem("esipRegistros")||"[]");}
function _setRegistros(a){localStorage.setItem("esipRegistros",JSON.stringify(a));}

function gerarQR(){
    const n=nome.value.trim(), e=evento.value.trim(), c=cpf.value.trim(), p=portaria.value;
    if(!n||!e||c.length!==11) return alert("Dados invÃ¡lidos");

    const dataHora=agora();
    ultimoID=p+"-INGR-"+Math.random().toString(36).substr(2,8).toUpperCase();

    qrcode.innerHTML="";
    new QRCode(qrcode,{text:ultimoID,width:250,height:250});

    let r=_getRegistros();
    r.push({nome:n,evento:e,cpf:c,portaria:p,id:ultimoID,dataHora});
    _setRegistros(r);

    status.textContent="QR gerado em "+dataHora;
}

logoEvento.onchange=e=>{
    const f=e.target.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
        LOGO_EVENTO_DATAURL=ev.target.result;
        previewLogo.src=LOGO_EVENTO_DATAURL;
        previewLogo.style.display="block";
    };
    r.readAsDataURL(f);
};

function baixarPDF(){
    if(!ultimoID) return;
    const r=_getRegistros().find(x=>x.id===ultimoID);
    const {jsPDF}=window.jspdf;
    const d=new jsPDF();

    if(LOGO_EVENTO_DATAURL)d.addImage(LOGO_EVENTO_DATAURL,"PNG",14,14,40,40);
    d.setFontSize(26);
    d.text(evento.value,LOGO_EVENTO_DATAURL?60:14,30);

    let y=60;
    d.setFontSize(16);
    d.text("Nome: "+r.nome,14,y);y+=10;
    d.text("CPF: "+r.cpf,14,y);y+=10;
    d.text("Portaria: "+r.portaria,14,y);y+=10;
    d.text("ID: "+r.id,14,y);y+=10;
    d.text("Data/Hora: "+r.dataHora,14,y);y+=14;

    d.setFontSize(36);
    d.setTextColor(255,0,0);
    const w=d.internal.pageSize.getWidth();
    const t="PORTARIA "+r.portaria;
    d.text(t,(w-d.getTextWidth(t))/2,y);y+=20;

    const img=qrcode.querySelector("canvas").toDataURL("image/png");
    d.addImage(img,"PNG",(w-120)/2,y,120,120);

    d.save("Ingresso_"+ultimoID+".pdf");
}

/* ADMIN */
function mostrarLogin(){loginBox.style.display="block";}
function fecharLogin(){loginBox.style.display="none";}
function validarAdmin(){
    if(senhaAdmin.value==="ADMIN2025"){
        loginBox.style.display="none";
        adminArea.style.display="block";
        carregarRegistros();
    } else alert("Senha incorreta");
}
function fecharAdmin(){adminArea.style.display="none";}

function carregarRegistros(){
    const t=registrosTabela;
    t.innerHTML="";
    const r=_getRegistros();
    contadorRegistros.textContent=r.length;

    r.forEach((x,i)=>{
        t.innerHTML+=`<tr>
        <td>${x.nome}</td>
        <td>${x.evento}</td>
        <td>${x.cpf}</td>
        <td>${x.portaria}</td>
        <td>${x.id}</td>
        <td>${x.dataHora}</td>
        <td><button onclick="excluirRegistro(${i})">ğŸ—‘ï¸</button></td>
        </tr>`;
    });
}

/* PDF PORTARIA */
function exportarPDFPortaria(){
    const p=prompt("Escolha a portaria:\nA, B ou C");
    if(!p) return;
    const port=p.toUpperCase();
    const r=_getRegistros().filter(x=>x.portaria===port);
    if(r.length===0) return alert("Nenhum registro");

    const {jsPDF}=window.jspdf;
    const d=new jsPDF();
    d.setFontSize(22);
    d.text("ğŸ“¡ ESIP-Sistemas",14,20);
    d.setFontSize(14);
    d.text("Evento: "+r[0].evento,14,32);
    d.text("Portaria: "+port,14,42);
    d.text("Total: "+r.length,14,52);

    let y=65;
    d.setFontSize(11);
    r.forEach((x,i)=>{
        d.text(`${i+1}. ${x.nome} | ${x.id} | ${x.dataHora}`,14,y);
        y+=7;
        if(y>280){d.addPage();y=20;}
    });

    d.save("Relatorio_Portaria_"+port+".pdf");
}

/* CSV */
function exportCSV(){
    const p=prompt("Digite a portaria:\nA, B ou C");
    if(!p) return;
    const port=p.toUpperCase();
    const r=_getRegistros().filter(x=>x.portaria===port);
    if(r.length===0) return alert("Sem registros");

    let csv="NOME,EVENTO,CPF,PORTARIA,ID,DATA_HORA\n";
    r.forEach(x=>csv+=`"${x.nome}","${x.evento}","${x.cpf}","${x.portaria}","${x.id}","${x.dataHora}"\n`);

    const b=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download="registros_"+port+".csv";
    a.click();
}

function excluirRegistro(i){
    if(!confirm("Excluir este registro?")) return;
    let r=_getRegistros();
    r.splice(i,1);
    _setRegistros(r);
    carregarRegistros();
}

function buscarPorCPF(){
    const cpfBusca=buscarCPF.value.trim();
    if(!cpfBusca) return;
    const t=registrosTabela;
    t.innerHTML="";
    const r=_getRegistros().filter(x=>x.cpf.includes(cpfBusca));
    contadorRegistros.textContent=r.length;

    r.forEach((x,i)=>{
        t.innerHTML+=`<tr>
        <td>${x.nome}</td>
        <td>${x.evento}</td>
        <td>${x.cpf}</td>
        <td>${x.portaria}</td>
        <td>${x.id}</td>
        <td>${x.dataHora}</td>
        <td><button onclick="excluirRegistro(${i})">ğŸ—‘ï¸</button></td>
        </tr>`;
    });
}

function limparRegistros(){
    if(confirm("Apagar tudo?")){
        localStorage.removeItem("esipRegistros");
        carregarRegistros();
    }
}
</script>

</body>
</html>

