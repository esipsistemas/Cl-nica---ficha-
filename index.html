<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ficha Clínica — Sistema Completo</title>
<!-- Dependências via CDN: jsPDF e html2canvas (para gerar PDFs com imagens) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{--brand:#0ea5a4;--muted:#666}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb;color:#111}
.header{background:linear-gradient(90deg,var(--brand),#7dd3fc);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
.header h1{margin:0;font-size:18px}
.container{max-width:1100px;margin:18px auto;padding:12px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
.card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 8px 24px rgba(17,24,39,0.06)}
.controls{display:flex;gap:8px;align-items:center}
.input,button,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6e6f2}
.button{background:var(--brand);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.small{font-size:13px;color:var(--muted)}
.client-list{max-height:520px;overflow:auto;margin-top:8px}
.client-item{padding:8px;border-radius:8px;border:1px solid #f0eef8;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.form-row .col{flex:1}
.photo-preview{width:80px;height:80px;border-radius:8px;object-fit:cover;border:1px solid #eee}
.signature{border:1px solid #ddd;border-radius:6px;display:block;touch-action:none}
.note{font-size:13px;color:var(--muted);margin-top:8px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="header">
  <h1>Ficha Clínica / Estética — Sistema (Offline)</h1>
  <div class="controls">
    <button class="button" id="btnBackup">Exportar JSON</button>
    <button class="button" id="btnImport">Importar JSON</button>
    <button class="button" id="btnPDFAll">Exportar PDF (Ficha)</button>
  </div>
</header>
<main class="container">
  <div class="grid">
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Clientes</strong>
        <div style="display:flex;gap:6px">
          <input id="searchClient" class="input" placeholder="Pesquisar..." />
          <button id="btnNewClient" class="button">+ Cliente</button>
        </div>
      </div>
      <div class="client-list" id="clientList"></div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="btnClearLocal" class="input">Limpar dados</button>
        <button id="btnPin" class="input">Ativar PIN</button>
      </div>
      <div class="note">Dados salvos no navegador (localStorage). Use Exportar para backup.</div>
    </aside>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <strong>Ficha / Procedimentos</strong>
          <div class="small">Crie ficha, registre procedimentos, fotos e termo assinado no celular.</div>
        </div>
        <div class="kv">
          <select id="selectClient" class="input"></select>
          <button id="btnNewProcedure" class="button">+ Procedimento</button>
        </div>
      </div>

      <div id="procedureArea"></div>

    </section>
  </div>
</main>

<!-- modal container -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:99;padding:20px">
  <div style="background:#fff;padding:14px;border-radius:12px;max-width:720px;width:100%;max-height:90vh;overflow:auto">
    <div id="modalContent"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="modalCancel" class="input">Cancelar</button>
      <button id="modalSave" class="button">Salvar</button>
    </div>
  </div>
</div>

<script>
/* ==========================
   SISTEMA FICHA CLÍNICA
========================== */
const STORAGE_KEY='ficha_clinica_v1';
let DB={clients:[]};
const $=id=>document.getElementById(id);
function uid(p='id'){return p+Math.random().toString(36).slice(2,9)}
function save(){localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));}
function load(){const s=localStorage.getItem(STORAGE_KEY);DB=s?JSON.parse(s):{clients:[]};}
function todayStr(d=new Date()){return d.toISOString().split('T')[0]}

/* Escape (seguro para null/undefined) */
function escapeHtml(t){ const s = (t==null)?'':String(t); return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

/* Render Clientes */
function renderClients(filter=''){
  const listEl=$('clientList'); listEl.innerHTML='';
  const clients=DB.clients.filter(c=>(c.name||'').toLowerCase().includes(filter.toLowerCase()));
  clients.forEach(c=>{
    const div=document.createElement('div'); div.className='client-item';
    div.innerHTML=`
      <div style="display:flex;gap:8px;align-items:center">
        <img src="${c.photo||''}" class="photo-preview" style="${c.photo?'':'display:none'}" />
        <div>
          <div style="font-weight:600">${escapeHtml(c.name)}</div>
          <div class="small">${escapeHtml(c.phone||'')}</div>
        </div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="input" data-id="${c.id}" data-action="open">Abrir</button>
        <button class="input" data-id="${c.id}" data-action="export">JSON</button>
        <button class="input" data-id="${c.id}" data-action="del">Apagar</button>
      </div>`;
    listEl.appendChild(div);
  });
  const sel=$('selectClient');
  sel.innerHTML='<option value="">-- Selecionar cliente --</option>'+
    DB.clients.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
}

/* Modal genérico */
function openModal(html,onSave){return new Promise(res=>{
  $('modalContent').innerHTML=html;
  $('modal').style.display='flex';
  // ensure modalSave visible
  $('modalSave').style.display = '';
  $('modalCancel').onclick=()=>{ $('modal').style.display='none'; res(false); };
  $('modalSave').onclick=async()=>{ const r=await onSave(); if(r!==false){ $('modal').style.display='none'; res(true);} };
});}
function openInfoModal(html){
  $('modalContent').innerHTML=html;
  $('modal').style.display='flex';
  // hide save for info modal
  $('modalSave').style.display='none';
  $('modalCancel').onclick=()=>{ $('modal').style.display='none'; $('modalSave').style.display=''; }
}

/* File → Base64 */
function fileToBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);})}

/* Cliente Modal */
async function openClientModal(id=null){
  const c=id?DB.clients.find(x=>x.id===id):{id:null,name:'',phone:'',birth:'',notes:'',photo:null,procedures:[]};
  const html=`<h3>Ficha do Cliente</h3>
    <div class='form-row'><div class='col'><label>Nome</label><input id='m_name' class='input' value='${escapeHtml(c.name)}'/></div></div>
    <div class='form-row'><div class='col'><label>Telefone</label><input id='m_phone' class='input' value='${escapeHtml(c.phone||'')}'/></div>
    <div class='col'><label>Nascimento</label><input id='m_birth' type='date' class='input' value='${c.birth||''}'/></div></div>
    <div><label>Observações</label><textarea id='m_notes' class='input' style='width:100%'>${escapeHtml(c.notes||'')}</textarea></div>
    <div style='margin-top:8px'><label>Foto</label><input id='m_photo' type='file' accept='image/*'></div>
    <img id='m_preview' class='photo-preview' src='${c.photo||''}' style='${c.photo?'':'display:none'};margin-top:8px'>`;

  await openModal(html, async()=>{
    const name=$('m_name').value.trim(); if(!name) return alert('Nome obrigatório');
    const phone=$('m_phone').value.trim(); const birth=$('m_birth').value; const notes=$('m_notes').value.trim();
    let photo=c.photo||null;
    const f=$('m_photo').files[0]; if(f) photo=await fileToBase64(f);
    if(c.id){Object.assign(c,{name,phone,birth,notes,photo}); const i=DB.clients.findIndex(x=>x.id===c.id); DB.clients[i]=c;}
    else DB.clients.push({id:uid('c_'),name,phone,birth,notes,photo,procedures:[]});
    save(); renderClients($('searchClient').value||'');
  });

  setTimeout(()=>{
    const inp = $('m_photo');
    if(!inp) return;
    inp.onchange=async()=>{const f=inp.files[0]; if(!f) return; const b=await fileToBase64(f); $('m_preview').src=b; $('m_preview').style.display='block';};
  },100);
}

/* Procedimentos */
async function openProcedureModal(cid,pid=null){
  const client=DB.clients.find(x=>x.id===cid);
  const p=pid?client.procedures.find(x=>x.id===pid):{id:null,date:todayStr(),procedure:'',professional:'',products:'',notes:'',before:null,after:null,signature:null};
  const html=`<h3>Procedimento - ${escapeHtml(client.name)}</h3>
    <div class='form-row'><div class='col'><label>Data</label><input id='p_date' type='date' class='input' value='${p.date}'/></div>
    <div class='col'><label>Procedimento</label><input id='p_name' class='input' value='${escapeHtml(p.procedure)}'/></div></div>
    <div class='form-row'><div class='col'><label>Profissional</label><input id='p_prof' class='input' value='${escapeHtml(p.professional||'')}'/></div>
    <div class='col'><label>Produtos</label><input id='p_prod' class='input' value='${escapeHtml(p.products||'')}'/></div></div>
    <div><label>Observações</label><textarea id='p_notes' class='input' style='width:100%'>${escapeHtml(p.notes||'')}</textarea></div>

    <div style='display:flex;gap:10px;margin-top:8px;flex-wrap:wrap'>
      <div style='min-width:160px'><label>Antes</label><input id='p_before' type='file' accept='image/*'><img id='preview_before' class='photo-preview' src='${p.before||''}' style='${p.before?'':'display:none'};margin-top:4px'></div>
      <div style='min-width:160px'><label>Depois</label><input id='p_after' type='file' accept='image/*'><img id='preview_after' class='photo-preview' src='${p.after||''}' style='${p.after?'':'display:none'};margin-top:4px'></div>
    </div>

    <div style='margin-top:8px'>
      <label>Assinatura</label>
      <div style='border:1px solid #eee;padding:8px;border-radius:6px;margin-top:6px'>
        <canvas id='sig_canvas' width='500' height='150' class='signature' style='width:100%;max-width:100%;height:150px;display:block;'></canvas>
        <div style='display:flex;gap:8px;margin-top:6px'><button id='sig_clear' class='input'>Limpar</button><button id='sig_save' class='input'>Salvar assinatura</button></div>
      </div>
    </div>`;

  await openModal(html, async()=>{
    const date=$('p_date').value; const name=$('p_name').value.trim(); if(!date||!name) return alert('Campos obrigatórios');
    const prof=$('p_prof').value.trim(); const prod=$('p_prod').value.trim(); const notes=$('p_notes').value.trim();
    let before=p.before,after=p.after;
    const fb=$('p_before').files[0]; if(fb) before=await fileToBase64(fb);
    const fa=$('p_after').files[0]; if(fa) after=await fileToBase64(fa);
    const sig=window._temp_signature||p.signature||null; delete window._temp_signature;

    if(p.id){Object.assign(p,{date,procedure:name,professional:prof,products:prod,notes,before,after,signature:sig});}
    else client.procedures.push({id:uid('p_'),date,procedure:name,professional:prof,products:prod,notes,before,after,signature:sig});

    save(); renderProcedureArea(cid); renderClients($('searchClient').value||'');
  });

  // setup signature canvas & previews
  setTimeout(()=>{
    const canvas = $('sig_canvas');
    if(!canvas) return;
    const previewBefore = $('preview_before');
    const previewAfter = $('preview_after');
    const inputBefore = $('p_before');
    const inputAfter = $('p_after');
    const btnClear = $('sig_clear');
    const btnSave = $('sig_save');

    // Responsive pixel ratio handling
    function resizeCanvasToDisplaySize(canvasEl){
      const rect = canvasEl.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const width = Math.round(rect.width * dpr);
      const height = Math.round(rect.height * dpr);
      if(canvasEl.width !== width || canvasEl.height !== height){
        // preserve current drawing
        const old = document.createElement('canvas');
        old.width = canvasEl.width;
        old.height = canvasEl.height;
        old.getContext('2d').drawImage(canvasEl,0,0);
        canvasEl.width = width;
        canvasEl.height = height;
        const ctx = canvasEl.getContext('2d');
        ctx.scale(dpr, dpr);
        // draw previous (scaled down to new dpr)
        ctx.drawImage(old, 0, 0, canvasEl.width/dpr, canvasEl.height/dpr);
      } else {
        // ensure context scaled if first time
        const ctx = canvasEl.getContext('2d');
        // Only scale once if not scaled
        // To avoid double-scaling we'll reset transform
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(dpr, dpr);
      }
    }

    // initial resize
    resizeCanvasToDisplaySize(canvas);

    // re-resize on window resize (debounced)
    let resizeTimer;
    function onResize(){
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>resizeCanvasToDisplaySize(canvas), 150);
    }
    window.addEventListener('resize', onResize);

    const ctx = canvas.getContext('2d');
    // Because we scaled the context by dpr above, set drawing styles in CSS pixels
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';

    // pointer drawing with capture
    let drawing = false;
    let pointerId = null;

    function getPosFromEvent(e){
      const rect = canvas.getBoundingClientRect();
      // use clientX/Y and map to CSS pixels coordinates (not the high-res buffer)
      const x = (e.clientX - rect.left);
      const y = (e.clientY - rect.top);
      return { x, y };
    }

    canvas.addEventListener('pointerdown', function (e) {
      // support only primary button / primary touch
      if (e.button && e.button !== 0) return;
      drawing = true;
      pointerId = e.pointerId;
      canvas.setPointerCapture(pointerId);
      const pos = getPosFromEvent(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
      e.preventDefault();
    });

    canvas.addEventListener('pointermove', function (e) {
      if (!drawing || e.pointerId !== pointerId) return;
      const pos = getPosFromEvent(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      e.preventDefault();
    });

    function endPointer(e){
      if (!drawing || e.pointerId !== pointerId) return;
      drawing = false;
      try{ canvas.releasePointerCapture(pointerId); }catch(err){}
      pointerId = null;
      e.preventDefault();
    }
    canvas.addEventListener('pointerup', endPointer);
    canvas.addEventListener('pointercancel', endPointer);
    canvas.addEventListener('pointerleave', function(e){
      // do not end on leave to allow capture; but if pointer not captured, end
      if (!canvas.hasPointerCapture || !canvas.hasPointerCapture(e.pointerId)) {
        endPointer(e);
      }
    });

    // clear button
    btnClear.onclick = () => {
      // clear drawing area (account for device pixel ratio)
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    // save button
    btnSave.onclick = () => {
      // export as PNG at displayed size
      // To avoid scaling problems, draw a temporary canvas at CSS pixels and export
      const rect = canvas.getBoundingClientRect();
      const tmp = document.createElement('canvas');
      tmp.width = Math.round(rect.width);
      tmp.height = Math.round(rect.height);
      const tmpCtx = tmp.getContext('2d');
      // draw current canvas content scaled down to CSS pixels
      tmpCtx.drawImage(canvas, 0, 0, tmp.width, tmp.height);
      window._temp_signature = tmp.toDataURL('image/png');
      alert('Assinatura salva');
    };

    // image previews
    if (inputBefore) inputBefore.onchange = async () => {
      const f = inputBefore.files[0];
      if (!f) return;
      const b = await fileToBase64(f);
      if (previewBefore) { previewBefore.src = b; previewBefore.style.display = 'block'; }
    };
    if (inputAfter) inputAfter.onchange = async () => {
      const f = inputAfter.files[0];
      if (!f) return;
      const b = await fileToBase64(f);
      if (previewAfter) { previewAfter.src = b; previewAfter.style.display = 'block'; }
    };

    // if existing signature, draw it (scale to canvas)
    if (p.signature) {
      const img = new Image();
      img.onload = () => {
        // draw image filling canvas's displayed size
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        // draw into the high-res buffer so it maintains quality
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // drawImage scaled to buffer size
        ctx.drawImage(img, 0, 0, canvas.width / dpr, canvas.height / dpr);
      };
      img.src = p.signature;
    }

  },120);
}

/* Render Área Cliente */
function renderProcedureArea(cid){
  const area=$('procedureArea'); area.innerHTML=''; if(!cid) return;
  const c=DB.clients.find(x=>x.id===cid);
  const h=document.createElement('div'); h.style.display='flex'; h.style.justifyContent='space-between';
  h.innerHTML=`<div><strong>Ficha: ${escapeHtml(c.name)}</strong><div class='small'>${escapeHtml(c.phone||'')}</div></div>
  <div style='display:flex;gap:8px'><button id='btnExportClient' class='input'>JSON</button><button id='btnPDFClient' class='input'>PDF</button></div>`;
  area.appendChild(h);

  const obs=document.createElement('div'); obs.className='card'; obs.style.marginTop='8px'; obs.innerHTML=`<strong>Observações</strong><div class='small'>${escapeHtml(c.notes||'')}</div>`;
  area.appendChild(obs);

  const procs=document.createElement('div'); procs.style.marginTop='10px'; procs.innerHTML='<strong>Procedimentos</strong>';
  if(!c.procedures.length) procs.innerHTML+='<div class="small">Nenhum registrado.</div>';
  else c.procedures.slice().sort((a,b)=>a.date>b.date?-1:1).forEach(p=>{
    const div=document.createElement('div'); div.className='card'; div.style.marginTop='8px';
    div.innerHTML=`<div style='display:flex;justify-content:space-between;'>
      <div><strong>${escapeHtml(p.procedure)}</strong><div class='small'>${p.date} — ${escapeHtml(p.professional||'')}</div></div>
      <div style='display:flex;gap:8px'>
        <button class='input' data-action='view' data-pid='${p.id}' data-cid='${cid}'>Ver</button>
        <button class='input' data-action='edit' data-pid='${p.id}' data-cid='${cid}'>Editar</button>
        <button class='input' data-action='del' data-pid='${p.id}' data-cid='${cid}'>Apagar</button>
      </div></div>`;
    procs.appendChild(div);
  });
  area.appendChild(procs);

  setTimeout(()=>{
    const btnExport = $('btnExportClient'); if(btnExport) btnExport.onclick=()=>downloadClientJSON(cid);
    const btnPdf = $('btnPDFClient'); if(btnPdf) btnPdf.onclick=()=>exportClientPDF(cid);
    procs.querySelectorAll('button').forEach(b=>{
      b.onclick=()=>{
        const a=b.dataset.action,pid=b.dataset.pid;
        if(a==='view') viewProcedure(cid,pid);
        if(a==='edit') openProcedureModal(cid,pid);
        if(a==='del'){ if(confirm('Apagar?')){c.procedures=c.procedures.filter(x=>x.id!==pid); save(); renderProcedureArea(cid);} }
      }
    });
  },50);
}

/* View Procedure */
function viewProcedure(cid,pid){
  const c=DB.clients.find(x=>x.id===cid);
  const p=c.procedures.find(x=>x.id===pid);
  let html=`<h3>${escapeHtml(p.procedure)}</h3><div><strong>Data:</strong> ${p.date}</div>
    <div><strong>Profissional:</strong> ${escapeHtml(p.professional||'')}</div>
    <div style='margin-top:8px'><strong>Produtos:</strong> ${escapeHtml(p.products||'')}</div>
    <div style='margin-top:8px'><strong>Notas:</strong><div class='small'>${escapeHtml(p.notes||'')}</div></div>`;
  if(p.before) html+=`<div style='margin-top:8px'><strong>Antes</strong><img src='${p.before}' class='photo-preview'></div>`;
  if(p.after) html+=`<div style='margin-top:8px'><strong>Depois</strong><img src='${p.after}' class='photo-preview'></div>`;
  if(p.signature) html+=`<div style='margin-top:8px'><strong>Assinatura</strong><img src='${p.signature}' style='max-width:100%;border:1px solid #eee;border-radius:8px'></div>`;
  openInfoModal(html);
}

/* Export JSON geral */
function downloadJSON(){const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ficha_clinica_backup.json'; a.click();}
function downloadClientJSON(id){const c=DB.clients.find(x=>x.id===id); if(!c) return; const blob=new Blob([JSON.stringify(c,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cliente_'+c.name.replace(/\s+/g,'_')+'.json'; a.click();}

/* Import JSON */
function openImport(){const i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=()=>{
  const f=i.files[0]; const r=new FileReader();
  r.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(data.clients){DB=data; save(); renderClients(); alert('Importado');}
      else if(data.id){const ex=DB.clients.find(x=>x.id===data.id); if(ex){if(confirm('Substituir?')){DB.clients=DB.clients.map(c=>c.id===data.id?data:c);} } else DB.clients.push(data); save(); renderClients();}
    }catch(err){alert('Arquivo inválido')}
  };
  r.readAsText(f);
}; i.click();}

/* PDF export */
async function exportClientPDF(id){
  const c=DB.clients.find(x=>x.id===id); if(!c) return;
  const wrap=document.createElement('div'); wrap.style.width='700px'; wrap.style.padding='14px'; wrap.style.background='#fff';
  wrap.innerHTML=`<h2>Ficha - ${escapeHtml(c.name)}</h2>
  <div><strong>Telefone:</strong> ${escapeHtml(c.phone||'')}</div>
  <div><strong>Nascimento:</strong> ${escapeHtml(c.birth||'')}</div>
  <div style='margin-top:8px'><strong>Observações:</strong><div>${escapeHtml(c.notes||'')}</div></div>`;
  c.procedures.forEach(p=>{
    const d=document.createElement('div'); d.style.marginTop='10px';
    d.innerHTML=`<h3>${escapeHtml(p.procedure)}</h3><div>${p.date} — ${escapeHtml(p.professional||'')}</div><div>${escapeHtml(p.notes||'')}</div>`;
    if(p.before) d.innerHTML+=`<div><img src='${p.before}' style='max-width:100%'></div>`;
    if(p.after) d.innerHTML+=`<div><img src='${p.after}' style='max-width:100%'></div>`;
    if(p.signature) d.innerHTML+=`<div><img src='${p.signature}' style='max-width:100%'></div>`;
    wrap.appendChild(d);
  });
  document.body.appendChild(wrap);
  try{
    const canvas=await html2canvas(wrap,{scale:1});
    const img=canvas.toDataURL('image/png');
    const pdf=new jspdf.jsPDF('p','pt','a4');
    const w=595; const h=canvas.height*w/canvas.width;
    pdf.addImage(img,'PNG',0,0,w,h);
    pdf.save('ficha_'+c.name.replace(/\s+/g,'_')+'.pdf');
  }catch(e){alert('Erro PDF: '+e.message)}
  document.body.removeChild(wrap);
}

async function exportAllToPDF(){for(const c of DB.clients) await exportClientPDF(c.id);}

/* Eventos */
window.onload=()=>{
  load(); renderClients();
  $('btnBackup').onclick=downloadJSON;
  $('btnImport').onclick=openImport;
  $('btnPDFAll').onclick=exportAllToPDF;
  $('btnNewClient').onclick=()=>openClientModal();
  $('btnNewProcedure').onclick=()=>{const cid=$('selectClient').value; if(!cid) return alert('Escolha um cliente'); openProcedureModal(cid);} ;
  $('searchClient').oninput=e=>renderClients(e.target.value);
  $('clientList').onclick=e=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id=btn.dataset.id, a=btn.dataset.action;
    if(a==='open'){$('selectClient').value=id; renderProcedureArea(id);} 
    if(a==='export') downloadClientJSON(id);
    if(a==='del'){ if(confirm('Apagar?')){ DB.clients=DB.clients.filter(c=>c.id!==id); save(); renderClients(); }}
  };
  $('selectClient').onchange=e=>renderProcedureArea(e.target.value);
  $('btnClearLocal').onclick=()=>{if(confirm('Limpar tudo?')){localStorage.removeItem(STORAGE_KEY); DB={clients:[]}; renderClients(); $('procedureArea').innerHTML='';}};
};
</script>
</body>
</html>

